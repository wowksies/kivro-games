<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kivro Games</title>
    <meta name="description" content="Premium unblocked games library and study tools.">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kivro Games">
    <meta name="theme-color" content="#050505">

    <link id="apple-touch-icon" rel="apple-touch-icon" href="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/onsigma67.png">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logoactual.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #ffffff;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            transition: background-color 0.5s ease;
        }

        /* --- SCHOOL MODE STYLES --- */
        body.school-mode {
            background-color: #f3f4f6; /* Light gray */
            color: #1f2937; /* Dark gray text */
        }
        body.school-mode .plasma-background,
        body.school-mode .falling-lights-container,
        body.school-mode #game-grid-section,
        body.school-mode .intro-card-bg {
            display: none !important;
        }
        body.school-mode .glass-header {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            backdrop-filter: none;
        }
        body.school-mode .text-white { color: #1f2937 !important; }
        body.school-mode .text-gray-300 { color: #4b5563 !important; }
        body.school-mode .liquid-glass {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            backdrop-filter: none;
        }
        
        /* --- GAME MODE BACKGROUNDS --- */
        .plasma-background {
            background: radial-gradient(circle at 10% 20%, var(--theme-primary, rgba(124, 58, 237, 0.15)) 0%, rgba(0, 0, 0, 0) 50%),
                        radial-gradient(circle at 90% 80%, var(--theme-secondary, rgba(79, 70, 229, 0.15)) 0%, rgba(0, 0, 0, 0) 50%),
                        #0f0f1a;
            background-size: 200% 200%;
            min-height: 100vh; position: fixed; inset: 0;
            z-index: -3;
            will-change: transform;
            transition: background 1s ease;
        }

        #gradient-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2; pointer-events: none; opacity: 0.6;
        }

        .falling-lights-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none; overflow: hidden;
        }

        .falling-light {
            position: absolute; top: -150px; width: 1px; height: 150px;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.15) 50%, rgba(255,255,255,0));
            animation: fall-light linear infinite;
        }

        @keyframes fall-light {
            0% { transform: translateY(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(120vh); opacity: 0; }
        }

        /* --- UI STYLES --- */
        .liquid-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            position: relative; overflow: hidden;
        }

        .glass-header {
            background: rgba(5, 5, 8, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: background 0.3s ease;
            padding-top: env(safe-area-inset-top);
            height: auto; min-height: 80px;
        }

        .header-inner {
            height: 80px; display: flex; align-items: center; justify-content: space-between;
        }

        /* --- AUTH & MODALS --- */
        .auth-modal {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .auth-modal.active { opacity: 1; pointer-events: auto; }

        .glass-input {
            background: rgba(20, 20, 25, 0.6) !important;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1) !important;
            color: white;
        }
        body.school-mode .glass-input {
            background: #f9fafb !important;
            border: 1px solid #d1d5db !important;
            color: #1f2937;
        }

        /* --- GAME CARDS --- */
        .game-card {
            border-radius: 24px;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform: translateZ(0); background: rgba(255, 255, 255, 0.05);
        }
        @media (hover: hover) {
            .game-card:hover {
                transform: translateY(-10px) scale(1.03);
                border-color: rgba(255, 255, 255, 0.4);
                background: rgba(255, 255, 255, 0.1);
                z-index: 20;
            }
        }
        .game-card img { transition: transform 0.6s; }
        .game-card:hover img { transform: scale(1.12); }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        
        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .splash-exit { transform: translateY(-100%); pointer-events: none; }
        #cinematic-splash {
            position: fixed; inset: 0; background-color: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.6s cubic-bezier(0.76, 0, 0.24, 1);
        }
        
        /* Flashcard Styles */
        .flashcard {
            perspective: 1000px;
            height: 200px;
            cursor: pointer;
        }
        .flashcard-inner {
            position: relative; width: 100%; height: 100%;
            text-align: center; transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            border-radius: 1rem; padding: 1rem;
            font-size: 1.25rem; font-weight: bold;
        }
        .flashcard-front { background-color: #ffffff; color: #000; border: 1px solid #ccc; }
        .flashcard-back { background-color: #4f46e5; color: white; transform: rotateY(180deg); }
        body:not(.school-mode) .flashcard-front { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }

        /* Avatar Selection */
        .pfp-option { border: 2px solid transparent; transition: all 0.2s; }
        .pfp-option:hover { transform: scale(1.1); }
        .pfp-option.selected { border-color: #6366f1; box-shadow: 0 0 15px rgba(99, 102, 241, 0.5); }
    </style>
</head>
<body class="antialiased">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, getDocs, query, orderBy, limit, increment } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBtYl6jDTWcLeigSSJorVEoBg6zO5VX7GA",
            authDomain: "kivro-flashacrds.firebaseapp.com",
            projectId: "kivro-flashacrds",
            storageBucket: "kivro-flashacrds.firebasestorage.app",
            messagingSenderId: "438500561290",
            appId: "1:438500561290:web:136d586b62d464d0c4b873",
            measurementId: "G-T4YDJYRP5N"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose to window for UI usage
        window.fbAuth = auth;
        window.fbDb = db;
        
        // --- AUTH LOGIC ---
        window.registerUser = async (email, password, username, pfpUrl, themeColor) => {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                await updateProfile(user, { displayName: username, photoURL: pfpUrl });
                
                // Create User Doc
                await setDoc(doc(db, "users", user.uid), {
                    username: username,
                    email: email,
                    pfp: pfpUrl,
                    theme: themeColor,
                    playtimeMinutes: 0,
                    createdAt: new Date()
                });

                closeModal('auth-modal');
                alert("Account Created!");
            } catch (error) {
                alert("Error: " + error.message);
            }
        };

        window.loginUser = async (email, password) => {
            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal('auth-modal');
            } catch (error) {
                alert("Login Failed: " + error.message);
            }
        };

        window.logoutUser = async () => {
            await signOut(auth);
            window.location.reload();
        };

        // --- PLAYTIME TRACKER ---
        let playtimeInterval;
        onAuthStateChanged(auth, async (user) => {
            const loginBtn = document.getElementById('login-btn-header');
            const userMenu = document.getElementById('user-menu-header');
            
            if (user) {
                loginBtn.classList.add('hidden');
                userMenu.classList.remove('hidden');
                document.getElementById('user-name-display').innerText = user.displayName;
                document.getElementById('user-pfp-display').src = user.photoURL || 'https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logoactual.png';
                
                // Load User Preferences
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    applyTheme(data.theme);
                }

                // Start Playtime Tracker (Updates every 60s)
                playtimeInterval = setInterval(async () => {
                    await updateDoc(doc(db, "users", user.uid), {
                        playtimeMinutes: increment(1)
                    });
                }, 60000); 

                loadFlashcardDecks(user.uid);

            } else {
                loginBtn.classList.remove('hidden');
                userMenu.classList.add('hidden');
                clearInterval(playtimeInterval);
            }
        });

        // --- LEADERBOARD LOGIC ---
        window.loadLeaderboard = async () => {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '<div class="text-center text-sm p-2">Loading...</div>';
            
            const q = query(collection(db, "users"), orderBy("playtimeMinutes", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            
            list.innerHTML = '';
            let rank = 1;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const item = document.createElement('div');
                item.className = "flex items-center justify-between p-3 bg-white/5 rounded-lg mb-2 border border-white/10";
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-indigo-400 w-6">#${rank++}</span>
                        <img src="${data.pfp}" class="w-8 h-8 rounded-full border border-white/20">
                        <span class="font-semibold text-sm">${data.username}</span>
                    </div>
                    <span class="text-xs text-gray-400 font-mono">${data.playtimeMinutes}m</span>
                `;
                list.appendChild(item);
            });
        };

        // --- FLASHCARD LOGIC ---
        window.createDeck = async (title) => {
            const user = auth.currentUser;
            if(!user) return alert("Login to create flashcards");
            
            await addDoc(collection(db, `flashcards/${user.uid}/decks`), {
                title: title,
                cards: [],
                createdAt: new Date()
            });
            loadFlashcardDecks(user.uid);
            closeModal('create-deck-modal');
        };

        async function loadFlashcardDecks(uid) {
            const container = document.getElementById('decks-container');
            const q = query(collection(db, `flashcards/${uid}/decks`));
            const snapshot = await getDocs(q);
            
            container.innerHTML = '';
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const div = document.createElement('div');
                div.className = "liquid-glass p-6 rounded-2xl hover:scale-105 transition-transform cursor-pointer border border-white/10";
                if(document.body.classList.contains('school-mode')) {
                    div.className = "bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all cursor-pointer border border-gray-200 text-gray-800";
                }
                
                div.innerHTML = `
                    <h3 class="text-xl font-bold mb-2">${data.title}</h3>
                    <p class="text-sm opacity-70">${data.cards ? data.cards.length : 0} Cards</p>
                `;
                div.onclick = () => window.openDeckEditor(docSnap.id, data);
                container.appendChild(div);
            });
        }

        window.saveCardToDeck = async (deckId, front, back) => {
             const user = auth.currentUser;
             const deckRef = doc(db, `flashcards/${user.uid}/decks`, deckId);
             const deckSnap = await getDoc(deckRef);
             const currentCards = deckSnap.data().cards || [];
             
             currentCards.push({front, back});
             await updateDoc(deckRef, { cards: currentCards });
             window.openDeckEditor(deckId, { ...deckSnap.data(), cards: currentCards }); // Refresh UI
        };

        window.openDeckEditor = (deckId, deckData) => {
            document.getElementById('study-dash').classList.add('hidden');
            document.getElementById('deck-editor').classList.remove('hidden');
            document.getElementById('current-deck-title').innerText = deckData.title;
            document.getElementById('active-deck-id').value = deckId;
            
            const list = document.getElementById('card-list-display');
            list.innerHTML = '';
            const cards = deckData.cards || [];
            
            cards.forEach(c => {
                const card = document.createElement('div');
                card.className = "flashcard mb-4 w-full max-w-md mx-auto";
                card.innerHTML = `
                    <div class="flashcard-inner">
                        <div class="flashcard-front">${c.front}</div>
                        <div class="flashcard-back">${c.back}</div>
                    </div>
                `;
                card.onclick = () => card.classList.toggle('flipped');
                list.appendChild(card);
            });
        };
    </script>

    <div class="plasma-background"></div>
    <div id="gradient-canvas"></div>
    <div class="falling-lights-container" id="falling-lights"></div>

    <div id="cinematic-splash">
        <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logoactual.png" class="w-24 h-24 rounded-2xl shadow-2xl mb-4 animate-pulse">
        <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-indigo-400">KIVRO</h1>
    </div>

    <header class="sticky top-0 z-50 w-full glass-header">
        <div class="max-w-7xl mx-auto px-4 header-inner gap-4">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.reload()">
                <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logoactual.png" class="w-10 h-10 rounded-xl shadow-lg border border-white/10">
                <span id="site-title" class="text-xl font-bold text-white hidden sm:block">Kivro</span>
            </div>

            <div class="flex items-center gap-2" id="nav-tabs">
                <div class="liquid-glass relative flex p-1 rounded-full backdrop-blur-md">
                    <div id="tab-pill" class="absolute top-1 bottom-1 bg-indigo-600 rounded-full transition-all duration-300 opacity-0"></div>
                    <button onclick="switchTab('Games')" id="tab-Games" class="tab-btn relative z-10 px-4 py-2 text-sm font-bold text-white">GAMES</button>
                    <button onclick="switchTab('Apps')" id="tab-Apps" class="tab-btn relative z-10 px-4 py-2 text-sm font-bold text-gray-400 hover:text-white">APPS</button>
                    <button onclick="switchTab('School')" id="tab-School" class="tab-btn relative z-10 px-4 py-2 text-sm font-bold text-gray-400 hover:text-white">STUDY</button>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button id="login-btn-header" onclick="openModal('auth-modal')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded-full text-sm font-bold transition-all shadow-lg shadow-indigo-500/20">
                    Login
                </button>

                <div id="user-menu-header" class="hidden flex items-center gap-3 relative group">
                    <div class="text-right hidden sm:block">
                        <div id="user-name-display" class="text-sm font-bold">User</div>
                        <div class="text-[10px] text-green-400">Online</div>
                    </div>
                    <img id="user-pfp-display" src="" class="w-10 h-10 rounded-full border-2 border-indigo-500 cursor-pointer">
                    
                    <div class="absolute right-0 top-12 w-48 bg-gray-900 border border-white/10 rounded-xl shadow-2xl p-2 hidden group-hover:block transition-all z-50">
                        <button onclick="openModal('profile-modal')" class="w-full text-left px-4 py-2 text-sm hover:bg-white/10 rounded-lg">Edit Profile</button>
                        <button onclick="toggleSchoolMode()" class="w-full text-left px-4 py-2 text-sm hover:bg-white/10 rounded-lg text-yellow-400">Toggle School Mode</button>
                        <div class="h-px bg-white/10 my-1"></div>
                        <button onclick="logoutUser()" class="w-full text-left px-4 py-2 text-sm hover:bg-red-500/20 text-red-400 rounded-lg">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 min-h-screen">

        <div id="game-grid-section">
            <div class="intro-card-bg p-8 md:p-12 mb-10 text-center flex flex-col items-center justify-center relative overflow-hidden rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl">
                <h1 class="text-5xl sm:text-7xl font-black text-white mb-4 tracking-tighter">
                    Kivro <span class="text-indigo-400">Games</span>
                </h1>
                <p class="text-gray-400 mb-6">Level up your profile. Climb the leaderboards.</p>
                <div class="flex gap-4">
                    <button onclick="loadLeaderboard(); openModal('leaderboard-modal')" class="px-6 py-2 bg-yellow-500/20 text-yellow-300 border border-yellow-500/50 rounded-full font-bold text-sm hover:bg-yellow-500/30 transition-all flex items-center gap-2">
                        <span>üèÜ</span> Leaderboard
                    </button>
                </div>
            </div>

            <div class="mb-6 relative">
                <input type="text" id="search-input" placeholder="Search games..." class="w-full glass-input rounded-xl px-5 py-3 outline-none text-white">
            </div>

            <div id="game-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
        </div>

        <div id="school-section" class="hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold mb-1 title-text">My Studies</h2>
                    <p class="text-sm text-gray-400">Review your flashcards</p>
                </div>
                <button onclick="openModal('create-deck-modal')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition-all">+ New Deck</button>
            </div>

            <div id="study-dash">
                <div id="decks-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center col-span-full py-10 opacity-50">Log in to create and save flashcards.</div>
                </div>
            </div>

            <div id="deck-editor" class="hidden">
                <button onclick="document.getElementById('deck-editor').classList.add('hidden'); document.getElementById('study-dash').classList.remove('hidden')" class="mb-4 text-indigo-400 hover:text-white">‚Üê Back to Decks</button>
                <h2 id="current-deck-title" class="text-2xl font-bold mb-6">Deck Title</h2>
                <input type="hidden" id="active-deck-id">

                <div class="mb-8 p-4 bg-white/5 rounded-xl border border-white/10">
                    <h3 class="font-bold mb-3">Add New Card</h3>
                    <input id="new-front" placeholder="Front (Question)" class="w-full p-2 mb-2 bg-black/20 rounded border border-white/10 text-white">
                    <input id="new-back" placeholder="Back (Answer)" class="w-full p-2 mb-2 bg-black/20 rounded border border-white/10 text-white">
                    <button onclick="addCardToActiveDeck()" class="w-full bg-green-600 py-2 rounded font-bold hover:bg-green-500">Add Card</button>
                </div>

                <div id="card-list-display" class="space-y-4"></div>
            </div>
        </div>

    </main>

    <div id="auth-modal" class="auth-modal">
        <div class="liquid-glass p-8 rounded-3xl max-w-sm w-full relative">
            <button onclick="closeModal('auth-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button>
            
            <h2 class="text-2xl font-bold mb-6 text-center text-white">Access Kivro</h2>
            
            <div class="flex mb-4 border-b border-white/10">
                <button onclick="toggleAuthMode('login')" class="flex-1 py-2 text-indigo-400 font-bold border-b-2 border-indigo-500" id="btn-mode-login">Login</button>
                <button onclick="toggleAuthMode('signup')" class="flex-1 py-2 text-gray-400 font-bold" id="btn-mode-signup">Sign Up</button>
            </div>

            <div id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email" class="w-full glass-input p-3 rounded-lg">
                <input type="password" id="login-pass" placeholder="Password" class="w-full glass-input p-3 rounded-lg">
                <button onclick="loginUser(document.getElementById('login-email').value, document.getElementById('login-pass').value)" class="w-full bg-indigo-600 py-3 rounded-xl font-bold text-white shadow-lg hover:bg-indigo-500">Enter</button>
            </div>

            <div id="signup-form" class="space-y-4 hidden">
                <input type="text" id="reg-user" placeholder="Username" class="w-full glass-input p-3 rounded-lg">
                <input type="email" id="reg-email" placeholder="Email" class="w-full glass-input p-3 rounded-lg">
                <input type="password" id="reg-pass" placeholder="Password" class="w-full glass-input p-3 rounded-lg">
                
                <p class="text-xs text-gray-400 mt-2">Choose Avatar:</p>
                <div class="flex gap-2 overflow-x-auto pb-2" id="pfp-selector">
                    <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logoactual.png" class="w-10 h-10 rounded-full cursor-pointer pfp-option selected" onclick="selectPfp(this)">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-10 h-10 rounded-full cursor-pointer pfp-option" onclick="selectPfp(this)">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka" class="w-10 h-10 rounded-full cursor-pointer pfp-option" onclick="selectPfp(this)">
                </div>

                <div class="flex gap-2 mt-2">
                    <div class="w-6 h-6 rounded-full bg-indigo-500 cursor-pointer border-2 border-white" onclick="selectedTheme='#7c3aed'"></div>
                    <div class="w-6 h-6 rounded-full bg-pink-500 cursor-pointer" onclick="selectedTheme='#ec4899'"></div>
                    <div class="w-6 h-6 rounded-full bg-blue-500 cursor-pointer" onclick="selectedTheme='#3b82f6'"></div>
                </div>

                <button onclick="handleRegister()" class="w-full bg-purple-600 py-3 rounded-xl font-bold text-white shadow-lg hover:bg-purple-500">Create Profile</button>
            </div>
        </div>
    </div>

    <div id="create-deck-modal" class="auth-modal">
        <div class="liquid-glass p-6 rounded-2xl w-80 relative text-center">
            <button onclick="closeModal('create-deck-modal')" class="absolute top-2 right-4 text-2xl">√ó</button>
            <h3 class="text-xl font-bold mb-4">New Deck</h3>
            <input id="deck-title-input" class="w-full glass-input p-2 rounded mb-4" placeholder="Deck Name (e.g. Science)">
            <button onclick="createDeck(document.getElementById('deck-title-input').value)" class="bg-indigo-600 px-6 py-2 rounded-full font-bold">Create</button>
        </div>
    </div>

    <div id="leaderboard-modal" class="auth-modal">
        <div class="liquid-glass p-6 rounded-3xl w-full max-w-md relative max-h-[80vh] overflow-y-auto">
            <button onclick="closeModal('leaderboard-modal')" class="absolute top-4 right-4 text-white">‚úï</button>
            <div class="text-center mb-6">
                <span class="text-4xl">üëë</span>
                <h2 class="text-2xl font-bold mt-2">Top Players</h2>
                <p class="text-xs text-gray-400">Ranked by active playtime</p>
            </div>
            <div id="leaderboard-list" class="space-y-2"></div>
        </div>
    </div>

    <div id="profile-modal" class="auth-modal">
        <div class="liquid-glass p-6 rounded-3xl w-full max-w-sm relative text-center">
            <button onclick="closeModal('profile-modal')" class="absolute top-4 right-4 text-white">‚úï</button>
            <h2 class="text-xl font-bold mb-4">Profile Settings</h2>
            <p class="text-sm text-gray-400 mb-2">Change Theme</p>
            <div class="flex justify-center gap-4 mb-6">
                <button onclick="updateTheme('#7c3aed')" class="w-10 h-10 rounded-full bg-indigo-600 border border-white/20"></button>
                <button onclick="updateTheme('#ec4899')" class="w-10 h-10 rounded-full bg-pink-600 border border-white/20"></button>
                <button onclick="updateTheme('#22c55e')" class="w-10 h-10 rounded-full bg-green-600 border border-white/20"></button>
                <button onclick="updateTheme('#ef4444')" class="w-10 h-10 rounded-full bg-red-600 border border-white/20"></button>
            </div>
            <p class="text-xs text-gray-500">Changes save automatically</p>
        </div>
    </div>

    <script>
        // --- GAME DATA ---
        const THUMB_BASE = "https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Thumbnails/";
        const GITHUB_BASE = "https://raw.githack.com/HTML5GameArchive/gfiles/master/games/";
        
        const gamesList = [
            { id: 5, title: "2048", category: "Puzzle", imgUrl: THUMB_BASE + "2048.png", gameUrl: "https://kivro-game-library.onrender.com//2048/index.html" },
            { id: 2, title: "Flappy Bird", category: "Arcade", imgUrl: THUMB_BASE + "Flappy-Bird.jpg", gameUrl: "https://kivro-game-library.onrender.com//flappybird/index.html" },
            { id: 18, title: "Subway Surfers", category: "Runner", imgUrl: THUMB_BASE + "Subway-Surfers.jpg", gameUrl: "https://raw.githack.com/testingherokuapp/subwaysurfer/main/index.html" },
            { id: 10, title: "Drive Mad", category: "Racing", imgUrl: THUMB_BASE + "Drive-Mad.jpg", gameUrl: "https://kivro-game-library.onrender.com//drivemad/index.html" },
            { id: 21, title: "Stickman Hook", category: "Arcade", imgUrl: THUMB_BASE + "stickman-hook.png", gameUrl: "https://kivro-game-library.onrender.com//StickmanHook/index.html" },
            { id: 23, title: "Block Blast", category: "Puzzle", imgUrl: THUMB_BASE + "block-blast.jpeg", gameUrl: "https://kivro-game-library.onrender.com//blockblast/index.html" },
            { id: 14, title: "Slope", category: "Runner", imgUrl: THUMB_BASE + "slope.png", gameUrl: "https://kivro-game-library.onrender.com//Slope/index.html" },
            { id: 1, title: "Retro Bowl", category: "Sports", imgUrl: THUMB_BASE + "Retro-Ball.webp", gameUrl: GITHUB_BASE + "retrobowl/index.html" },
            { id: 8, title: "Chess", category: "Strategy", imgUrl: THUMB_BASE + "chess.jpg", gameUrl: GITHUB_BASE + "chess/index.html" },
            { id: 9, title: "Cookie Clicker", category: "Idle", imgUrl: THUMB_BASE + "Cookie-Clicker.jpg", gameUrl: GITHUB_BASE + "cookieclicker/index.html" },
            { id: 3, title: "Geo Dash", category: "Rhythm", imgUrl: THUMB_BASE + "Geometry-Dash.webp", gameUrl: "https://geometryite.vercel.app/" },
            { id: 15, title: "Google Snake", category: "Arcade", imgUrl: THUMB_BASE + "Google-Snake.jpg", gameUrl: "https://raw.githack.com/KAYAZzz/kivro-library/main/Snake/index.html" },
            { id: 11, title: "Monkey Mart", category: "Simulation", imgUrl: THUMB_BASE + "Monkey-Mart.jpg", gameUrl: "https://kivro-game-library.onrender.com//monkeymart/index.html" },
            { id: 12, title: "PacMan", category: "Arcade", imgUrl: THUMB_BASE + "Pacman.jpg", gameUrl: GITHUB_BASE + "pacman/index.html" },
            { id: 50, title: "Wordle", category: "Puzzle", imgUrl: THUMB_BASE + "IMG_0829.jpeg", gameUrl: "https://wordle-actual.vercel.app" },
            { id: 20, title: "Dino Runner", category: "Runner", imgUrl: THUMB_BASE + "Dino.jpg", gameUrl: "https://kivro-game-library.onrender.com//chromedino/index.html" },
            { id: 25, title: "Hole.io", category: "Arcade", imgUrl: THUMB_BASE + "Hole.png", gameUrl: "https://kivro-game-library.onrender.com//HoleIO/index.html" },
            { id: 30, title: "Paper.io", category: "Strategy", imgUrl: THUMB_BASE + "paper-io.png", gameUrl: GITHUB_BASE + "paperio/index.html" },
            { id: 65, title: "8 Ball Pool", category: "Sports", imgUrl: THUMB_BASE + "8ballpool.webp", gameUrl: "https://kivro-game-library.onrender.com//pool-pixijs/index.html" },
            { id: 1001, title: "BlackFlix", category: "App", imgUrl: THUMB_BASE + "IMG_0988.jpeg", gameUrl: "https://ixlgroupjam.lovable.app/" }
        ];

        // --- LOCAL STATE ---
        let selectedPfp = 'https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logoactual.png';
        let selectedTheme = '#7c3aed';

        // --- UI FUNCTIONS ---
        function renderGames(filter = 'Games') {
            const grid = document.getElementById('game-grid');
            const search = document.getElementById('search-input').value.toLowerCase();
            grid.innerHTML = '';
            
            const filtered = gamesList.filter(g => {
                const matchesSearch = g.title.toLowerCase().includes(search);
                if(filter === 'Apps') return g.category === 'App' && matchesSearch;
                if(filter === 'Games') return g.category !== 'App' && matchesSearch;
                return matchesSearch; // For 'School' mode we hide grid anyway
            });

            filtered.forEach(item => {
                const el = document.createElement('div');
                el.className = 'game-card cursor-pointer relative overflow-hidden group';
                el.onclick = () => window.open(item.gameUrl, '_blank');
                el.innerHTML = `
                    <div class="h-32 sm:h-40 relative">
                        <img src="${item.imgUrl}" loading="lazy" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent opacity-100 group-hover:opacity-50 transition-opacity"></div>
                        <span class="absolute bottom-2 left-2 text-[10px] bg-white/10 backdrop-blur px-2 py-0.5 rounded text-white font-bold border border-white/10">${item.category}</span>
                    </div>
                    <div class="p-3 bg-white/5">
                        <h3 class="text-sm font-bold text-white truncate">${item.title}</h3>
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        // Tab Switching
        function switchTab(tab) {
            document.getElementById('game-grid-section').classList.remove('hidden');
            document.getElementById('school-section').classList.add('hidden');
            
            // Adjust Pill
            const btn = document.getElementById(`tab-${tab}`);
            const pill = document.getElementById('tab-pill');
            const tabs = document.querySelectorAll('.tab-btn');
            
            pill.style.opacity = '1';
            pill.style.width = btn.offsetWidth + 'px';
            pill.style.left = btn.offsetLeft + 'px';
            
            tabs.forEach(t => {
                t.classList.remove('text-white');
                t.classList.add('text-gray-400');
            });
            btn.classList.remove('text-gray-400');
            btn.classList.add('text-white');

            if(tab === 'School') {
                document.getElementById('game-grid-section').classList.add('hidden');
                document.getElementById('school-section').classList.remove('hidden');
            } else {
                renderGames(tab);
            }
        }

        // Toggle School Mode (Visual)
        function toggleSchoolMode() {
            document.body.classList.toggle('school-mode');
            const isSchool = document.body.classList.contains('school-mode');
            
            if(isSchool) {
                document.getElementById('site-title').innerText = "Kivro Study";
                document.getElementById('tab-pill').style.display = 'none';
                document.getElementById('nav-tabs').classList.add('hidden');
                document.getElementById('game-grid-section').classList.add('hidden');
                document.getElementById('school-section').classList.remove('hidden');
            } else {
                document.getElementById('site-title').innerText = "Kivro";
                document.getElementById('tab-pill').style.display = 'block';
                document.getElementById('nav-tabs').classList.remove('hidden');
                switchTab('Games'); // Reset
            }
        }

        // Modals
        function openModal(id) {
            const el = document.getElementById(id);
            el.classList.remove('hidden');
            el.style.display = 'flex';
            setTimeout(() => el.classList.add('active'), 10);
        }
        function closeModal(id) {
            const el = document.getElementById(id);
            el.classList.remove('active');
            setTimeout(() => {
                el.classList.add('hidden');
                el.style.display = 'none';
            }, 300);
        }

        // Auth Form Toggle
        function toggleAuthMode(mode) {
            if(mode === 'login') {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('btn-mode-login').className = "flex-1 py-2 text-indigo-400 font-bold border-b-2 border-indigo-500";
                document.getElementById('btn-mode-signup').className = "flex-1 py-2 text-gray-400 font-bold";
            } else {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
                document.getElementById('btn-mode-signup').className = "flex-1 py-2 text-indigo-400 font-bold border-b-2 border-indigo-500";
                document.getElementById('btn-mode-login').className = "flex-1 py-2 text-gray-400 font-bold";
            }
        }

        // Registration Handling
        function selectPfp(img) {
            document.querySelectorAll('.pfp-option').forEach(i => i.classList.remove('selected'));
            img.classList.add('selected');
            selectedPfp = img.src;
        }

        function handleRegister() {
            const u = document.getElementById('reg-user').value;
            const e = document.getElementById('reg-email').value;
            const p = document.getElementById('reg-pass').value;
            if(u && e && p) {
                window.registerUser(e, p, u, selectedPfp, selectedTheme);
            } else {
                alert("Please fill all fields");
            }
        }

        // Theme Handling
        async function updateTheme(color) {
            applyTheme(color);
            const user = window.fbAuth.currentUser;
            if(user) {
                await window.fbDb.updateDoc(window.fbDb.doc(window.fbDb.getFirestore(), "users", user.uid), {
                    theme: color
                });
            }
            closeModal('profile-modal');
        }

        function applyTheme(color) {
            document.documentElement.style.setProperty('--theme-primary', color + '40'); // 40 is hex opacity
            document.documentElement.style.setProperty('--theme-secondary', color + '20');
            const btns = document.querySelectorAll('.bg-indigo-600');
            // Note: Ideally use CSS vars for all colors, but for this structure we change the background gradient
        }

        // Card Creation Helper
        function addCardToActiveDeck() {
            const deckId = document.getElementById('active-deck-id').value;
            const f = document.getElementById('new-front').value;
            const b = document.getElementById('new-back').value;
            if(f && b) {
                window.saveCardToDeck(deckId, f, b);
                document.getElementById('new-front').value = '';
                document.getElementById('new-back').value = '';
            }
        }

        // Init
        window.onload = () => {
            renderGames();
            document.getElementById('search-input').addEventListener('input', () => renderGames());
            
            // Remove Splash
            setTimeout(() => {
                document.getElementById('cinematic-splash').classList.add('splash-exit');
            }, 1500);

            // Init Lights
            const container = document.getElementById('falling-lights');
            for(let i=0; i<30; i++){
                const l = document.createElement('div');
                l.className = 'falling-light';
                l.style.left = Math.random()*100 + 'vw';
                l.style.animationDuration = (3+Math.random()*5)+'s';
                l.style.animationDelay = (Math.random()*5)+'s';
                container.appendChild(l);
            }
        };

    </script>
</body>
</html>
